<!DOCTYPE html> 
<html lang="ja">
  <head>
    <title>IXADB</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=720"/>
    <link rel="stylesheet" type="text/css" href="css/common.css">
  </head>

  <body>
    <h1>想定部隊スペック</h1>
    <table>
      <tbody>
        <tr>
          <th></th>
          <th>部隊長</th>
          <th>小隊長</th>
          <th>小隊長</th>
          <th>小隊長</th>
        </tr>
        <tr>
          <th>名前</th>
          <td><input id="busho_name_1" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_name_2" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_name_3" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_name_4" class="para" type="text" value="----" onchange="createTable();"></td>
        </tr>
        <tr>
          <th>コスト</th>
          <td><input id="busho_cost_1" class="para" type="number" value="4.0" onchange="createTable();"></td>
          <td><input id="busho_cost_2" class="para" type="number" value="4.0" onchange="createTable();"></td>
          <td><input id="busho_cost_3" class="para" type="number" value="3.5" onchange="createTable();"></td>
          <td><input id="busho_cost_4" class="para" type="number" value="3.5" onchange="createTable();"></td>
        </tr>
        <tr>
          <th>ランク</th>
          <td><input id="busho_rank_1" class="para" type="number" value="6" onchange="createTable();"></td>
          <td><input id="busho_rank_2" class="para" type="number" value="6" onchange="createTable();"></td>
          <td><input id="busho_rank_3" class="para" type="number" value="6" onchange="createTable();"></td>
          <td><input id="busho_rank_4" class="para" type="number" value="6" onchange="createTable();"></td>
        </tr>
        <!--
        <tr>
          <th>レベル</th>
          <td><input id="busho_lv_1" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_lv_2" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_lv_3" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_lv_4" class="para" type="number" value="450" onchange="createTable();"></td>
        </tr>
        <tr>
          <th>攻撃</th>
          <td><input id="busho_atk_1" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_atk_2" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_atk_3" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_atk_4" class="para" type="number" value="450" onchange="createTable();"></td>
        </tr>
        <tr>
          <th>防御</th>
          <td><input id="busho_def_1" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_def_2" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_def_3" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_def_4" class="para" type="number" value="450" onchange="createTable();"></td>
        </tr>
        -->
        <tr>
          <th>兵法</th>
          <td><input id="busho_int_1" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_int_2" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_int_3" class="para" type="number" value="450" onchange="createTable();"></td>
          <td><input id="busho_int_4" class="para" type="number" value="450" onchange="createTable();"></td>
        </tr>
        <!--
        <tr>
          <th>技</th>
          <td><input id="busho_skill1_1" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill1_2" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill1_3" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill1_4" class="para" type="text" value="----" onchange="createTable();"></td>
        </tr>
        <tr>
          <th>技</th>
          <td><input id="busho_skill2_1" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill2_2" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill2_3" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill2_4" class="para" type="text" value="----" onchange="createTable();"></td>
        </tr>
        <tr>
          <th>技</th>
          <td><input id="busho_skill3_1" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill3_2" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill3_3" class="para" type="text" value="----" onchange="createTable();"></td>
          <td><input id="busho_skill3_4" class="para" type="text" value="----" onchange="createTable();"></td>
        </tr>
        -->
      </tbody>
    </table>
    <!--
    <canvas id="graph" width="1024px" height="64px">図形を表示するには、canvasタグをサポートしたブラウザが必要です。</canvas>
    -->
    
    <table>
      <tbody>
        <tr>
          <th>付与対象</th>
          <th>時間帯</th>
          <th>加勢</th>
          <th>攻撃側武将数</th>
          <th>防御側武将数</th>
        </tr>
        <tr>
          <td>
            <select id="busho_select_idx" onchange="createTable();">
              <option id="busho_select_1" value="0">----</option>
              <option id="busho_select_2" value="1">----</option>
              <option id="busho_select_3" value="2">----</option>
              <option id="busho_select_4" value="3">----</option>
            </select>
          </td>
          <td>
            <select id="time_zone" onchange="createTable();">
              <option value="day">通常（02時～20時）</option>
              <option value="night">夜戦（20時～翌02時）</option>
            </select>
          </td>
          <td><input id="kasei" class="para" type="checkbox" onchange="createTable();"></td>
          <td><input id="busho_atk_num" class="para" style="width:40px;" type="number" value="1" min="1" max="40" onchange="createTable();">武将</td>
          <td><input id="busho_def_num" class="para" style="width:40px;" type="number" value="1" min="1" max="180" onchange="createTable();">武将</td>
        </tr>
      </tbody>
    </table>
    
    <div>発動率補整: <span id="add_rate" /></div>
    <div><span id="goryu"/></div>
    
    <h1>スキル一覧</h1>
    <p>
      <label>対象フィルタ<select id="type_filter" onChange="createTable();">
        <option>なし</option>
        <option>槍</option>
        <option>弓</option>
        <option>馬</option>
        <option>砲</option>
        <option>器</option>
        <option>将</option>
        <option>槍弓</option>
        <option>槍馬</option>
        <option>槍砲</option>
        <option>槍器</option>
        <option>弓馬</option>
        <option>弓砲</option>
        <option>弓器</option>
        <option>馬砲</option>
        <option>馬器</option>
        <option>槍弓馬</option>
        <option>槍弓砲</option>
        <option>槍弓器</option>
        <option>槍馬砲</option>
        <option>槍馬器</option>
        <option>槍砲器</option>
        <option>弓馬砲</option>
        <option>弓馬器</option>
        <option>弓砲器</option>
        <option>馬砲器</option>
        <option>槍弓馬砲</option>
        <option>槍弓馬器</option>
        <option>全</option>
      </select></label>
      <label>ソート順<select id="sort_type" onChange="createTable();">
        <option value="default">デフォルト</option>
        <option value="exp_atk">期待値順（攻撃）</option>
        <option value="exp_def">期待値順（防御）</option>
        <option value="exp_des">期待値順（破壊）</option>
      </select></label>
    </p>
    <table id="skill_table">
      <tbody>
      </tbody>
    </table>
    
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="table_skill.js"></script>
    <script type="text/javascript">
      //対応兵科,確認兵科
      function IsMatch(txt, t){
        if(txt=="全") return true;
        if(txt.indexOf("上級") != -1) return true;
        if(txt.indexOf("秘境兵") != -1) return true;
        var arr = t.split("");
        for(var i = 0 ; i < arr.length ; ++i){
          if(txt.indexOf(arr[i]) == -1) return false; //対応してない兵科が混じってた
        }
        return true;
      }
      
      //期待値計算
      function calcExpectedAtk(add_rate,data){ return Math.min(data.eff_per + add_rate,100) * data.eff_atk / 100; }
      function calcExpectedDef(add_rate,data){ return Math.min(data.eff_per + add_rate,100) * data.eff_def / 100; }
      function calcExpectedDes(add_rate,data){ return Math.min(data.eff_per + add_rate,100) * data.eff_des / 100; }
      
      //初期設定
      (function(){
        $('input').each(function(){
          var id = $(this).attr("id");
          var value = localStorage.getItem(id);
          if(value !== null) $(this).val(value);
        });
      })();
      
      /*
      var spec = [13000,390000,633565,935807];
      
      var canvas = document.getElementById('graph');
      if (canvas.getContext) {
        var context = canvas.getContext('2d');
        context.fillStyle = 'rgb(255,00,00)';
        context.strokeStyle = 'rgb(255,255,255)';
        var prev = 0;
        for(var i = 0 ; i < spec.length ; ++i){
          var value = spec[i]/2500;
          context.fillRect(4+prev,4,value-prev,16);
          context.strokeRect(4+prev,4,value-prev,16);
          prev = value;
        }
      }
      */
      
      function createTable(){
        //状態の保存
        $('input').each(function(){
          var id = $(this).attr("id");
          var value = $(this).val();
          if(value !== null){
            if($(this).attr("type") == "number"){
              var min = Number($(this).attr("min"));
              var max = Number($(this).attr("max"));
              value = Number(value);
              if(isNaN(min)==false && value < min) value = min;
              if(isNaN(max)==false && value > max) value = max;
            }
            $(this).val(value);
            localStorage.setItem(id,value);
          }
        });
        
        //初期化
        $('#skill_table').empty();
        
        //ヘッダ作成
        $('<tr>').appendTo('#skill_table').append([
          $('<th rowspan="2">スキル名</th>'),
          $('<th rowspan="2">対応兵科</th>'),
          $('<th colspan="3">期待値</th>'),
          $('<th rowspan="2">効果</th>'),
        ]);
        $('<tr>').appendTo('#skill_table').append([
          $('<th>攻撃</th>'),
          $('<th>防御</th>'),
          $('<th>破壊</th>'),
        ]);
        
        //武将選択
        $('#busho_select_1').text($('#busho_name_1').val());
        $('#busho_select_2').text($('#busho_name_2').val());
        $('#busho_select_3').text($('#busho_name_3').val());
        $('#busho_select_4').text($('#busho_name_4').val());
        var busho_select_idx = Number($('#busho_select_idx').val());
        
        
        //環境情報
        var filter = $('#type_filter').val();
        var env = {
          busho_atk_num: Number($('#busho_atk_num').val()),
          busho_def_num: Number($('#busho_def_num').val()),
          time_zone: $('#time_zone').val(),
          kasei: $('#kasei').val(),
          busho:[
            {cost:Number($('#busho_cost_1').val()), rank:Number($('#busho_rank_1').val())},
            {cost:Number($('#busho_cost_2').val()), rank:Number($('#busho_rank_2').val())},
            {cost:Number($('#busho_cost_3').val()), rank:Number($('#busho_rank_3').val())},
            {cost:Number($('#busho_cost_4').val()), rank:Number($('#busho_rank_4').val())},
          ]
        };
        
        //兵法値
        var busho_int_1 = Number($('#busho_int_1').val());
        var busho_int_2 = Number($('#busho_int_2').val());
        var busho_int_3 = Number($('#busho_int_3').val());
        var busho_int_4 = Number($('#busho_int_4').val());
        var busho_ints = [busho_int_1, busho_int_2, busho_int_3, busho_int_4];
        busho_ints.sort(function(a,b){return b - a;}); //ソートして軍師を決める
        var int_bonus = (busho_ints[0] / 100) + ((busho_ints[1]+busho_ints[2]+busho_ints[3]) / 600);
        //部隊ランクボーナス
        var rank_bonus_table = [0, 0.1, 0.2, 0.3, 0.45, 0.6, 0.75, 0.9, 1.1, 1.3, 1.5, 1.7, 1.95, 2.2, 2.45, 2.7, 3, 3.3, 3.6, 3.9, 4.3, 4.7, 5.1, 5.5, 6];
        var rank_bonus = rank_bonus_table[ env.busho[0].rank + env.busho[1].rank + env.busho[2].rank + env.busho[3].rank ];
        
        var add_rate = int_bonus+ rank_bonus;

        $('#add_rate').text("+"+add_rate.toFixed(2)+'% (兵法補正:'+int_bonus.toFixed(2)+'% + 部隊ランク補整:'+rank_bonus.toFixed(2)+'%)');

        $('#goryu').text(parseInt($('#busho_atk_num').val()/4)+'合流');
        
        var array = [];
        $.each(table_skill, function(key,value){
          var data = skill_type[value.t](env,busho_select_idx,value);
          if(filter!='なし' & !IsMatch(data.target,filter)) return;
          
          array.push({key:key,value:data});
        });
        
        switch($('#sort_type').val())
        {
          case 'exp_atk':
            array.sort(function(a,b){
              return (calcExpectedAtk(add_rate,b.value) - calcExpectedAtk(add_rate,a.value));
            });
            break;
          case 'exp_def':
            array.sort(function(a,b){
              return (calcExpectedDef(add_rate,b.value) - calcExpectedDef(add_rate,a.value));
            });
            break;
          case 'exp_des':
            array.sort(function(a,b){
              return (calcExpectedDes(add_rate,b.value) - calcExpectedDes(add_rate,a.value));
            });
            break;
        }
        
        var add_element = '';
        $.each(array, function(){
          var name = (this).key;
          var data = (this).value;
          var exp_atk = calcExpectedAtk(add_rate,data);
          var exp_def = calcExpectedDef(add_rate,data);
          var exp_des = calcExpectedDes(add_rate,data);
          
          add_element +=
            '<tr>'+
              '<td>'+name+'</td>'+
              '<td>'+
                '<span'+(data.yari ? '' : ' class="gray"')+'>槍</span>'+
                '<span'+(data.yumi ? '' : ' class="gray"')+'>弓</span>'+
                '<span'+(data.kiba ? '' : ' class="gray"')+'>馬</span>'+
                '<span'+(data.teppo ? '' : ' class="gray"')+'>砲</span>'+
                '<span'+(data.heiki ? '' : ' class="gray"')+'>器</span>'+
              '</td>'+
              (exp_atk != 0 ? '<td>'+exp_atk.toFixed(1)+'%' : '<td class="gray">-')+'</td>'+
              (exp_def != 0 ? '<td>'+exp_def.toFixed(1)+'%' : '<td class="gray">-')+'</td>'+
              (exp_des != 0 ? '<td>'+exp_des.toFixed(1)+'%' : '<td class="gray">-')+'</td>'+
              '<td class="l">'+data.desc+'</td>'+
            '</tr>';
        });
        
        $('#skill_table').append(add_element);
      }
      
      createTable();
    </script> 
  </body>
</html>